<!doctype html><html lang=ja><head><title>集合指向的なアプリケーション設定 · keepSTEEP</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="keepSTEEP"><meta name=description content="はじめに 見出しへのリンク Smart data structures and dumb code works a lot better than the other way around.&#34;(賢いデータ構造と愚かなコードは、その逆よりもずっとうまく機能する) という言葉があるように、優れたデータ構造を設計することはソフトウェア開発において重要である。ところが実務で様々な現場を経験すると、手続き型・関数型・オブジェクト指向といったプログラミングパラダイムやオニオンアーキテクチャなどのアーキテクチャにばかり注目が集まり、データ構造をいかにしてアプリケーションサーバに適用するかという視点が欠けていることが多いように思う。個人的な備忘録としてどのようにデータ構造を設計し、アプリケーションに適用するか一考する。
今回扱う範囲について 見出しへのリンク 一般的なアプリケーションサーバを対象とする データの取得はRDBを前提とする TypeScript/JavaScriptを使用する フレームワークは特に問わない 参考文献 見出しへのリンク プログラマのためのSQL 第4版
集合指向的なデータ構造設計 見出しへのリンク アプリケーションサーバにおけるデータ構造設計において重要なのは、データを「集合」として捉えることである。例えば、ユーザ情報を扱う場合、単一のユーザオブジェクトではなく、ユーザの集合を表現するデータ構造を設計する。これにより、データの一貫性を保ちやすくなり、操作も効率的になる。プログラミングとは手続きとデータの組み合わせであるが、データを集合として捉えることで、手続きも集合操作に基づいたものとなり、コードの可読性と保守性が向上する。
その良い例としてSQLを例に挙げる。SQLはデータ宣言言語（Data Declaration Language）・DML：データ操作言語（Data Manipulation Language）・DCL：データ制御言語（Data Control Language）の3つの要素から成り立っている。 SQLにおいては、データは常に集合として扱われ、単一のレコードを操作する場合でも、集合操作の一部として捉えられる。このように、データを集合として捉えることで、データの整合性を保ちつつ、効率的な操作が可能となる。
例えばSQLでユーザーに対するアクセスを手続き的に記述する場合、以下のようになる。
-- 手続き型: 1行ずつ処理(遅い、複雑) CREATE PROCEDURE GetActiveUsers() BEGIN DECLARE done INT DEFAULT FALSE; DECLARE user_id INT; DECLARE user_name VARCHAR(100); DECLARE is_active BOOLEAN; -- カーソル宣言 DECLARE user_cursor CURSOR FOR SELECT id, name, is_active FROM users; DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; -- 結果格納用の一時テーブル CREATE TEMPORARY TABLE active_users ( id INT, name VARCHAR(100) ); OPEN user_cursor; read_loop: LOOP FETCH user_cursor INTO user_id, user_name, is_active; IF done THEN LEAVE read_loop; END IF; -- 1行ずつ条件チェック IF is_active = TRUE THEN INSERT INTO active_users (id, name) VALUES (user_id, user_name); END IF; END LOOP; CLOSE user_cursor; -- 結果を返す SELECT * FROM active_users; DROP TEMPORARY TABLE active_users; END; 集合指向的に記述する場合、以下のようになる。"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="集合指向的なアプリケーション設定"><meta name=twitter:description content="はじめに 見出しへのリンク Smart data structures and dumb code works a lot better than the other way around.&#34;(賢いデータ構造と愚かなコードは、その逆よりもずっとうまく機能する) という言葉があるように、優れたデータ構造を設計することはソフトウェア開発において重要である。ところが実務で様々な現場を経験すると、手続き型・関数型・オブジェクト指向といったプログラミングパラダイムやオニオンアーキテクチャなどのアーキテクチャにばかり注目が集まり、データ構造をいかにしてアプリケーションサーバに適用するかという視点が欠けていることが多いように思う。個人的な備忘録としてどのようにデータ構造を設計し、アプリケーションに適用するか一考する。
今回扱う範囲について 見出しへのリンク 一般的なアプリケーションサーバを対象とする データの取得はRDBを前提とする TypeScript/JavaScriptを使用する フレームワークは特に問わない 参考文献 見出しへのリンク プログラマのためのSQL 第4版
集合指向的なデータ構造設計 見出しへのリンク アプリケーションサーバにおけるデータ構造設計において重要なのは、データを「集合」として捉えることである。例えば、ユーザ情報を扱う場合、単一のユーザオブジェクトではなく、ユーザの集合を表現するデータ構造を設計する。これにより、データの一貫性を保ちやすくなり、操作も効率的になる。プログラミングとは手続きとデータの組み合わせであるが、データを集合として捉えることで、手続きも集合操作に基づいたものとなり、コードの可読性と保守性が向上する。
その良い例としてSQLを例に挙げる。SQLはデータ宣言言語（Data Declaration Language）・DML：データ操作言語（Data Manipulation Language）・DCL：データ制御言語（Data Control Language）の3つの要素から成り立っている。 SQLにおいては、データは常に集合として扱われ、単一のレコードを操作する場合でも、集合操作の一部として捉えられる。このように、データを集合として捉えることで、データの整合性を保ちつつ、効率的な操作が可能となる。
例えばSQLでユーザーに対するアクセスを手続き的に記述する場合、以下のようになる。
-- 手続き型: 1行ずつ処理(遅い、複雑) CREATE PROCEDURE GetActiveUsers() BEGIN DECLARE done INT DEFAULT FALSE; DECLARE user_id INT; DECLARE user_name VARCHAR(100); DECLARE is_active BOOLEAN; -- カーソル宣言 DECLARE user_cursor CURSOR FOR SELECT id, name, is_active FROM users; DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; -- 結果格納用の一時テーブル CREATE TEMPORARY TABLE active_users ( id INT, name VARCHAR(100) ); OPEN user_cursor; read_loop: LOOP FETCH user_cursor INTO user_id, user_name, is_active; IF done THEN LEAVE read_loop; END IF; -- 1行ずつ条件チェック IF is_active = TRUE THEN INSERT INTO active_users (id, name) VALUES (user_id, user_name); END IF; END LOOP; CLOSE user_cursor; -- 結果を返す SELECT * FROM active_users; DROP TEMPORARY TABLE active_users; END; 集合指向的に記述する場合、以下のようになる。"><meta property="og:title" content="集合指向的なアプリケーション設定"><meta property="og:description" content="はじめに 見出しへのリンク Smart data structures and dumb code works a lot better than the other way around.&#34;(賢いデータ構造と愚かなコードは、その逆よりもずっとうまく機能する) という言葉があるように、優れたデータ構造を設計することはソフトウェア開発において重要である。ところが実務で様々な現場を経験すると、手続き型・関数型・オブジェクト指向といったプログラミングパラダイムやオニオンアーキテクチャなどのアーキテクチャにばかり注目が集まり、データ構造をいかにしてアプリケーションサーバに適用するかという視点が欠けていることが多いように思う。個人的な備忘録としてどのようにデータ構造を設計し、アプリケーションに適用するか一考する。
今回扱う範囲について 見出しへのリンク 一般的なアプリケーションサーバを対象とする データの取得はRDBを前提とする TypeScript/JavaScriptを使用する フレームワークは特に問わない 参考文献 見出しへのリンク プログラマのためのSQL 第4版
集合指向的なデータ構造設計 見出しへのリンク アプリケーションサーバにおけるデータ構造設計において重要なのは、データを「集合」として捉えることである。例えば、ユーザ情報を扱う場合、単一のユーザオブジェクトではなく、ユーザの集合を表現するデータ構造を設計する。これにより、データの一貫性を保ちやすくなり、操作も効率的になる。プログラミングとは手続きとデータの組み合わせであるが、データを集合として捉えることで、手続きも集合操作に基づいたものとなり、コードの可読性と保守性が向上する。
その良い例としてSQLを例に挙げる。SQLはデータ宣言言語（Data Declaration Language）・DML：データ操作言語（Data Manipulation Language）・DCL：データ制御言語（Data Control Language）の3つの要素から成り立っている。 SQLにおいては、データは常に集合として扱われ、単一のレコードを操作する場合でも、集合操作の一部として捉えられる。このように、データを集合として捉えることで、データの整合性を保ちつつ、効率的な操作が可能となる。
例えばSQLでユーザーに対するアクセスを手続き的に記述する場合、以下のようになる。
-- 手続き型: 1行ずつ処理(遅い、複雑) CREATE PROCEDURE GetActiveUsers() BEGIN DECLARE done INT DEFAULT FALSE; DECLARE user_id INT; DECLARE user_name VARCHAR(100); DECLARE is_active BOOLEAN; -- カーソル宣言 DECLARE user_cursor CURSOR FOR SELECT id, name, is_active FROM users; DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE; -- 結果格納用の一時テーブル CREATE TEMPORARY TABLE active_users ( id INT, name VARCHAR(100) ); OPEN user_cursor; read_loop: LOOP FETCH user_cursor INTO user_id, user_name, is_active; IF done THEN LEAVE read_loop; END IF; -- 1行ずつ条件チェック IF is_active = TRUE THEN INSERT INTO active_users (id, name) VALUES (user_id, user_name); END IF; END LOOP; CLOSE user_cursor; -- 結果を返す SELECT * FROM active_users; DROP TEMPORARY TABLE active_users; END; 集合指向的に記述する場合、以下のようになる。"><meta property="og:type" content="article"><meta property="og:url" content="https://oudon-mizusawa.github.io/keepSTEEP/posts/005/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2026-01-12T00:00:00+00:00"><meta property="article:modified_time" content="2026-01-12T00:00:00+00:00"><link rel=canonical href=https://oudon-mizusawa.github.io/keepSTEEP/posts/005/><link rel=preload href=/keepSTEEP/fonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/keepSTEEP/fonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/keepSTEEP/fonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/keepSTEEP/css/coder.min.fa74189526e858f964d89230d76de3b1dd7aa7d5e112c726978c80a47e8d34f5.css integrity="sha256-+nQYlSboWPlk2JIw123jsd16p9XhEscml4yApH6NNPU=" crossorigin=anonymous media=screen><link rel=stylesheet href=/keepSTEEP/css/coder-dark.min.a00e6364bacbc8266ad1cc81230774a1397198f8cfb7bcba29b7d6fcb54ce57f.css integrity="sha256-oA5jZLrLyCZq0cyBIwd0oTlxmPjPt7y6KbfW/LVM5X8=" crossorigin=anonymous media=screen><link rel=icon type=image/svg+xml href=/keepSTEEP/icons/logo.png sizes=any><link rel=icon type=image/png href=/keepSTEEP/icons/logo.png sizes=32x32><link rel=icon type=image/png href=/keepSTEEP/icons/logo.png sizes=16x16><link rel=apple-touch-icon href=/keepSTEEP/icons/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/keepSTEEP/icons/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://oudon-mizusawa.github.io/keepSTEEP/>keepSTEEP</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa-solid fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/keepSTEEP/about/>About</a></li><li class=navigation-item><a class=navigation-link href=/keepSTEEP/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/keepSTEEP/exhibition>Exhibition</a></li><li class=navigation-item><a class=navigation-link href=/keepSTEEP/favorite_books>Favorite Books</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://oudon-mizusawa.github.io/keepSTEEP/posts/005/>集合指向的なアプリケーション設定</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa-solid fa-calendar" aria-hidden=true></i>
<time datetime=2026-01-12T00:00:00Z>1月 12, 2026</time></span>
<span class=reading-time><i class="fa-solid fa-clock" aria-hidden=true></i>
4分で読めます</span></div></div></header><div class=post-content><h2 id=はじめに>はじめに
<a class=heading-link href=#%e3%81%af%e3%81%98%e3%82%81%e3%81%ab><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><pre tabindex=0><code>Smart data structures and dumb code works a lot better than the other way around.&#34;(賢いデータ構造と愚かなコードは、その逆よりもずっとうまく機能する)
</code></pre><p>という言葉があるように、優れたデータ構造を設計することはソフトウェア開発において重要である。ところが実務で様々な現場を経験すると、手続き型・関数型・オブジェクト指向といったプログラミングパラダイムやオニオンアーキテクチャなどのアーキテクチャにばかり注目が集まり、データ構造をいかにしてアプリケーションサーバに適用するかという視点が欠けていることが多いように思う。個人的な備忘録としてどのようにデータ構造を設計し、アプリケーションに適用するか一考する。</p><h2 id=今回扱う範囲について>今回扱う範囲について
<a class=heading-link href=#%e4%bb%8a%e5%9b%9e%e6%89%b1%e3%81%86%e7%af%84%e5%9b%b2%e3%81%ab%e3%81%a4%e3%81%84%e3%81%a6><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><ul><li>一般的なアプリケーションサーバを対象とする</li><li>データの取得はRDBを前提とする</li><li>TypeScript/JavaScriptを使用する</li><li>フレームワークは特に問わない</li></ul><h2 id=参考文献>参考文献
<a class=heading-link href=#%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>プログラマのためのSQL 第4版</p><h2 id=集合指向的なデータ構造設計>集合指向的なデータ構造設計
<a class=heading-link href=#%e9%9b%86%e5%90%88%e6%8c%87%e5%90%91%e7%9a%84%e3%81%aa%e3%83%87%e3%83%bc%e3%82%bf%e6%a7%8b%e9%80%a0%e8%a8%ad%e8%a8%88><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>アプリケーションサーバにおけるデータ構造設計において重要なのは、データを「集合」として捉えることである。例えば、ユーザ情報を扱う場合、単一のユーザオブジェクトではなく、ユーザの集合を表現するデータ構造を設計する。これにより、データの一貫性を保ちやすくなり、操作も効率的になる。プログラミングとは手続きとデータの組み合わせであるが、データを集合として捉えることで、手続きも集合操作に基づいたものとなり、コードの可読性と保守性が向上する。</p><p>その良い例としてSQLを例に挙げる。SQLはデータ宣言言語（Data Declaration Language）・DML：データ操作言語（Data Manipulation Language）・DCL：データ制御言語（Data Control Language）の3つの要素から成り立っている。
SQLにおいては、データは常に集合として扱われ、単一のレコードを操作する場合でも、集合操作の一部として捉えられる。このように、データを集合として捉えることで、データの整合性を保ちつつ、効率的な操作が可能となる。</p><p>例えばSQLでユーザーに対するアクセスを手続き的に記述する場合、以下のようになる。</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#8b949e;font-style:italic>-- 手続き型: 1行ずつ処理(遅い、複雑)
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>PROCEDURE</span><span style=color:#6e7681> </span>GetActiveUsers()<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>BEGIN</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>DECLARE</span><span style=color:#6e7681> </span>done<span style=color:#6e7681> </span>INT<span style=color:#6e7681> </span><span style=color:#ff7b72>DEFAULT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FALSE</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>DECLARE</span><span style=color:#6e7681> </span>user_id<span style=color:#6e7681> </span>INT;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>DECLARE</span><span style=color:#6e7681> </span>user_name<span style=color:#6e7681> </span>VARCHAR(<span style=color:#a5d6ff>100</span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>DECLARE</span><span style=color:#6e7681> </span>is_active<span style=color:#6e7681> </span>BOOLEAN;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic>-- カーソル宣言
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>  </span><span style=color:#ff7b72>DECLARE</span><span style=color:#6e7681> </span>user_cursor<span style=color:#6e7681> </span><span style=color:#ff7b72>CURSOR</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FOR</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span>id,<span style=color:#6e7681> </span>name,<span style=color:#6e7681> </span>is_active<span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>DECLARE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>CONTINUE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>HANDLER</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FOR</span><span style=color:#6e7681> </span><span style=color:#ff7b72>NOT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FOUND</span><span style=color:#6e7681> </span><span style=color:#ff7b72>SET</span><span style=color:#6e7681> </span>done<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>TRUE</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic>-- 結果格納用の一時テーブル
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>  </span><span style=color:#ff7b72>CREATE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>TEMPORARY</span><span style=color:#6e7681> </span><span style=color:#ff7b72>TABLE</span><span style=color:#6e7681> </span>active_users<span style=color:#6e7681> </span>(<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>id<span style=color:#6e7681> </span>INT,<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span>name<span style=color:#6e7681> </span>VARCHAR(<span style=color:#a5d6ff>100</span>)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>OPEN</span><span style=color:#6e7681> </span>user_cursor;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span>read_loop:<span style=color:#6e7681> </span>LOOP<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>FETCH</span><span style=color:#6e7681> </span>user_cursor<span style=color:#6e7681> </span><span style=color:#ff7b72>INTO</span><span style=color:#6e7681> </span>user_id,<span style=color:#6e7681> </span>user_name,<span style=color:#6e7681> </span>is_active;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>IF</span><span style=color:#6e7681> </span>done<span style=color:#6e7681> </span><span style=color:#ff7b72>THEN</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span>LEAVE<span style=color:#6e7681> </span>read_loop;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>END</span><span style=color:#6e7681> </span><span style=color:#ff7b72>IF</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#8b949e;font-style:italic>-- 1行ずつ条件チェック
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>    </span><span style=color:#ff7b72>IF</span><span style=color:#6e7681> </span>is_active<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>TRUE</span><span style=color:#6e7681> </span><span style=color:#ff7b72>THEN</span><span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>INSERT</span><span style=color:#6e7681> </span><span style=color:#ff7b72>INTO</span><span style=color:#6e7681> </span>active_users<span style=color:#6e7681> </span>(id,<span style=color:#6e7681> </span>name)<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>      </span><span style=color:#ff7b72>VALUES</span><span style=color:#6e7681> </span>(user_id,<span style=color:#6e7681> </span>user_name);<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>    </span><span style=color:#ff7b72>END</span><span style=color:#6e7681> </span><span style=color:#ff7b72>IF</span>;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>END</span><span style=color:#6e7681> </span>LOOP;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>CLOSE</span><span style=color:#6e7681> </span>user_cursor;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#8b949e;font-style:italic>-- 結果を返す
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#6e7681>  </span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>*</span><span style=color:#6e7681> </span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>active_users;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  
</span></span></span><span style=display:flex><span><span style=color:#6e7681>  </span><span style=color:#ff7b72>DROP</span><span style=color:#6e7681> </span><span style=color:#ff7b72>TEMPORARY</span><span style=color:#6e7681> </span><span style=color:#ff7b72>TABLE</span><span style=color:#6e7681> </span>active_users;<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>END</span>;<span style=color:#6e7681>
</span></span></span></code></pre></div><p>集合指向的に記述する場合、以下のようになる。</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#ff7b72>SELECT</span><span style=color:#6e7681> </span>id,<span style=color:#6e7681> </span>name<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>FROM</span><span style=color:#6e7681> </span>users<span style=color:#6e7681>
</span></span></span><span style=display:flex><span><span style=color:#6e7681></span><span style=color:#ff7b72>WHERE</span><span style=color:#6e7681> </span>is_active<span style=color:#6e7681> </span><span style=color:#ff7b72;font-weight:700>=</span><span style=color:#6e7681> </span><span style=color:#ff7b72>TRUE</span>;<span style=color:#6e7681>
</span></span></span></code></pre></div><p>また、これはTypeScript/JavaScriptのアプリケーションコードにおいても同様である。</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 手続き型
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> getActiveUsers(users: <span style=color:#ff7b72>User</span>[])<span style=color:#ff7b72;font-weight:700>:</span> User[] {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> activeUsers: <span style=color:#ff7b72>User</span>[] <span style=color:#ff7b72;font-weight:700>=</span> [];
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>for</span> (<span style=color:#ff7b72>const</span> user <span style=color:#ff7b72>of</span> users) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>if</span> (user.isActive) {
</span></span><span style=display:flex><span>        activeUsers.push(user);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> activeUsers;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// 集合指向的
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span><span style=color:#ff7b72>function</span> getActiveUsers(users: <span style=color:#ff7b72>User</span>[])<span style=color:#ff7b72;font-weight:700>:</span> User[] {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> users.filter(user <span style=color:#ff7b72;font-weight:700>=&gt;</span> user.isActive);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>つまりこれは、アクティブユーザーの定義を<code>ActiveUsers = { u ∈ Users | isActive(u) = true }</code>と集合として捉え、<code>filter</code>メソッドを用いてその集合を取得している。これにより、Usersに対する演算結果は明確となり、二値論理に基づく集合操作として、例外処理を不要とすることができる。</p><p>しかし、この辺りの説明だと、宣言的プログラミングという概念で十分説明可能であるし、わざわざ集合指向的という言葉を使う必要はないと思われる。ただ、なぜあえて集合指向的という言葉を使うかというと、実際の業務アプリケーションでは、RDBMSを用いてデータを扱うことが多く、その場合SQLの集合指向的な性質を理解し、アプリケーションコードに適用することが重要だからである。RDBMSは本質的に集合指向的なデータモデルを採用しており、SQLはその操作言語として設計されているため、アプリケーションコードも同様の視点で設計することで、データ構造を適切に扱い、実務的な問題をシンプルに解決することができると思う。</p><h2 id=集合指向的なapiサーバーの設計の一検討>集合指向的なAPIサーバーの設計の一検討
<a class=heading-link href=#%e9%9b%86%e5%90%88%e6%8c%87%e5%90%91%e7%9a%84%e3%81%aaapi%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc%e3%81%ae%e8%a8%ad%e8%a8%88%e3%81%ae%e4%b8%80%e6%a4%9c%e8%a8%8e><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>ここまでは集合指向的なデータ構造設計について述べてきたが、では実際のアプリケーションサーバーにおいてどのように適用するかを考える。</p><p>なお、実務を考慮して以下のようにアプリケーションのレイヤーを設計する</p><ul><li>プレゼンテーション層（例：GraphQL、REST API）&mldr; クライアントとの通信を担当・バリデーション</li><li>サービス層（ビジネスロジック）&mldr; ビジネスルールの実装</li><li>データアクセス層（データアクセス）&mldr; データベースとのやり取り(ここを集合指向的に設計する)</li></ul><p>また、CRUD操作を以下のように定義する</p><ul><li>作成(Create)：新しいエンティティを集合に追加する操作</li><li>読取(Read)：集合からエンティティを取得する操作</li><li>更新(Update)：集合内のエンティティを変更する操作</li><li>削除(Delete)：集合からエンティティを削除する操作</li></ul><p>プレゼンテーション層</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span>app.<span style=color:#ff7b72>get</span>(<span style=color:#a5d6ff>&#39;/users&#39;</span>, <span style=color:#ff7b72>async</span> (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  zod.<span style=color:#ff7b72>object</span>({<span style=color:#a5d6ff>`something validation rule`</span>}).parse(req.query);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>isValid) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid request&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> users <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> getUsers();
</span></span><span style=display:flex><span>  res.json(users);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.<span style=color:#ff7b72>get</span>(<span style=color:#a5d6ff>&#39;/users/:id&#39;</span>, <span style=color:#ff7b72>async</span> (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  zod.<span style=color:#ff7b72>object</span>({<span style=color:#a5d6ff>`something validation rule`</span>}).parse(req.params);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>isValid) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid request&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> getUser(req.params.id);
</span></span><span style=display:flex><span>  res.json(user);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.post(<span style=color:#a5d6ff>&#39;/users/search&#39;</span>, <span style=color:#ff7b72>async</span> (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  zod.<span style=color:#ff7b72>object</span>({<span style=color:#a5d6ff>`something validation rule`</span>}).parse(req.body);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>isValid) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid request&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> newUser <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> createUser(req.body);
</span></span><span style=display:flex><span>  res.status(<span style=color:#a5d6ff>201</span>).json(newUser);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.post(<span style=color:#a5d6ff>&#39;/users&#39;</span>, <span style=color:#ff7b72>async</span> (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>    zod.<span style=color:#ff7b72>object</span>({<span style=color:#a5d6ff>`something validation rule`</span>}).parse(req.body);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>isValid) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid request&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> newUser <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> createUser(req.body);
</span></span><span style=display:flex><span>  res.status(<span style=color:#a5d6ff>201</span>).json(newUser);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.put(<span style=color:#a5d6ff>&#39;/users/:id&#39;</span>, <span style=color:#ff7b72>async</span> (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  zod.<span style=color:#ff7b72>object</span>({<span style=color:#a5d6ff>`something validation rule`</span>}).parse(req.body);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>isValid) {
</span></span><span style=display:flex><span>      <span style=color:#ff7b72>return</span> res.status(<span style=color:#a5d6ff>400</span>).json({ error<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;Invalid request&#39;</span> });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> updatedUser <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> updateUser(req.params.id, req.body);
</span></span><span style=display:flex><span>  res.json(updatedUser);
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>app.<span style=color:#ff7b72>delete</span>(<span style=color:#a5d6ff>&#39;/users/:id&#39;</span>, <span style=color:#ff7b72>async</span> (req, res) <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>await</span> deleteUser(req.params.id);
</span></span><span style=display:flex><span>  res.status(<span style=color:#a5d6ff>204</span>).send();
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>サービス層</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> getUsers()<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>User</span><span style=color:#f85149>[]</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> users <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> db.select.<span style=color:#ff7b72>from</span>(<span style=color:#a5d6ff>&#39;users&#39;</span>).all();
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> dataAccess.getUsers(tx, users.map(u <span style=color:#ff7b72;font-weight:700>=&gt;</span> u.id));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> getUser()<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>User</span><span style=color:#f85149>[]</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> dataAccess.getUsers(tx, [id], needsDetails);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> searchUsers(somethingOpts<span style=color:#ff7b72;font-weight:700>:</span> {
</span></span><span style=display:flex><span>    needsSomething?: <span style=color:#ff7b72>boolean</span>;
</span></span><span style=display:flex><span>    needsMore?: <span style=color:#ff7b72>boolean</span>;
</span></span><span style=display:flex><span>    dateRange<span style=color:#ff7b72;font-weight:700>?:</span> { start: <span style=color:#ff7b72>Date</span>; end: <span style=color:#ff7b72>Date</span> };
</span></span><span style=display:flex><span>})<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>User</span><span style=color:#f85149>[]</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> query <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> db.select.<span style=color:#ff7b72>from</span>(<span style=color:#a5d6ff>&#39;users&#39;</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (somethingOpts.needsSomething) {
</span></span><span style=display:flex><span>    query.where(<span style=color:#a5d6ff>&#39;something1&#39;</span>, <span style=color:#79c0ff>true</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (somethingOpts.needsMore) {
</span></span><span style=display:flex><span>    query.innerJoin(<span style=color:#a5d6ff>&#39;something_table&#39;</span>, <span style=color:#a5d6ff>&#39;users.id&#39;</span>, <span style=color:#a5d6ff>&#39;something_table.user_id&#39;</span>); 
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (somethingOpts.dateRange) {
</span></span><span style=display:flex><span>      query.whereBetween(<span style=color:#a5d6ff>&#39;created_at&#39;</span>, [somethingOpts.dateRange.start, somethingOpts.dateRange.end]);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> users <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> query.all();
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> dataAccess.getUsers(tx, userIds);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> createUser(data: <span style=color:#ff7b72>any</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>User</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> userId <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> db.insert.into(<span style=color:#a5d6ff>&#39;users&#39;</span>).values(data).returning(<span style=color:#a5d6ff>&#39;id&#39;</span>);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> dataAccess.getUsers(tx, [userId])[<span style=color:#a5d6ff>0</span>];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> updateUser(id: <span style=color:#ff7b72>string</span>, data: <span style=color:#ff7b72>any</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>User</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> dataAccess.getUsers(tx, [id]);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>user) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;User not found&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>await</span> db.update(<span style=color:#a5d6ff>&#39;users&#39;</span>).<span style=color:#ff7b72>set</span>(data).where(<span style=color:#a5d6ff>&#39;id&#39;</span>, id);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> dataAccess.getUsers(tx, [id])[<span style=color:#a5d6ff>0</span>];
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> deleteUser(id: <span style=color:#ff7b72>string</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>void</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> user <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> dataAccess.getUsers(tx, [id]);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (<span style=color:#ff7b72;font-weight:700>!</span>user) {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>throw</span> <span style=color:#ff7b72>new</span> Error(<span style=color:#a5d6ff>&#39;User not found&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>await</span> db.<span style=color:#ff7b72>delete</span>.<span style=color:#ff7b72>from</span>(<span style=color:#a5d6ff>&#39;users&#39;</span>).where(<span style=color:#a5d6ff>&#39;id&#39;</span>, id);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> {};
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>データアクセス層</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#ff7b72>async</span> <span style=color:#ff7b72>function</span> getUsers(tx, userIds: <span style=color:#ff7b72>string</span>[], needsDetails <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#79c0ff>false</span>)<span style=color:#ff7b72;font-weight:700>:</span> Promise&lt;<span style=color:#7ee787>User</span><span style=color:#f85149>[]</span>&gt; {
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> query <span style=color:#ff7b72;font-weight:700>=</span> tx.select.<span style=color:#ff7b72>from</span>(<span style=color:#a5d6ff>&#39;users&#39;</span>).whereIn(<span style=color:#a5d6ff>&#39;id&#39;</span>, userIds);
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>if</span> (needsDetails) {
</span></span><span style=display:flex><span>    query.leftJoin(<span style=color:#a5d6ff>&#39;user_details&#39;</span>, <span style=color:#a5d6ff>&#39;users.id&#39;</span>, <span style=color:#a5d6ff>&#39;user_details.user_id&#39;</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>const</span> users <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> query.all();
</span></span><span style=display:flex><span>  <span style=color:#ff7b72>return</span> users;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>プレゼンテーション層で適切な値がサービス層に渡されることを前提とすることで、契約プログラミングを実現し、サービス層ではビジネスロジックに集中できるようになる。
サービス層では、ビジネスロジックに集中し、手続き的にコードを書くことができる。ビジネスロジックは例外処理を含むためエラーハンドリングを行いつつ、適宜データアクセス層を呼び出して必要なデータを取得・操作する。
そして、データアクセス層では、集合指向的にデータを扱うことで、効率的かつ一貫性のあるデータ操作を実現する。宣言的にデータをそうしているため、エラーハンドリングの必要がなく、コードの可読性と保守性が向上する。さらに、データのアクセスでは、ID指定により集合の範囲を限定し、パラメータにより指定した集合とその集合の関連エンティティを結合するかどうかを制御することで、必要なデータのみを効率的に取得できるようにする。</p><h2 id=整理>整理
<a class=heading-link href=#%e6%95%b4%e7%90%86><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>再度アプリケーションのレイヤーを抽象的なレベルで整理すると以下のようになる。</p><p><strong>プレゼンテーション層</strong></p><ul><li>契約プログラミングにおける事前条件を保証する</li></ul><p><strong>サービス層</strong></p><ul><li>ビジネスルールを実装する<ul><li>ビジネスルールに関する手続きを記述し、違反行為を例外として扱う</li><li>トランザクション境界の管理</li><li>複数のデータアクセス層の呼び出しを調整</li></ul></li></ul><p><strong>データアクセス層</strong></p><ul><li>データベースとのやり取りを集合指向的に設計する<ul><li>データを集合として捉え、宣言的にデータ操作を行う</li><li>SQLレベルでの最適化</li></ul></li></ul><p>このようにすることで、各レイヤーの責務が明確になり、コードの可読性と保守性が向上する。</p><h3 id=テスタビリティの向上>テスタビリティの向上
<a class=heading-link href=#%e3%83%86%e3%82%b9%e3%82%bf%e3%83%93%e3%83%aa%e3%83%86%e3%82%a3%e3%81%ae%e5%90%91%e4%b8%8a><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h3><p>集合指向的な設計は、テストのしやすさにも貢献する。</p><div class=highlight><pre tabindex=0 style=color:#e6edf3;background-color:#0d1117;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-typescript data-lang=typescript><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// データアクセス層のテスト: 純粋な集合操作なので予測可能
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>describe(<span style=color:#a5d6ff>&#39;dataAccess.getUsers&#39;</span>, () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  it(<span style=color:#a5d6ff>&#39;should return users for given IDs&#39;</span>, <span style=color:#ff7b72>async</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> users <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> dataAccess.getUsers([<span style=color:#a5d6ff>&#39;user1&#39;</span>, <span style=color:#a5d6ff>&#39;user2&#39;</span>]);
</span></span><span style=display:flex><span>    expect(users).toHaveLength(<span style=color:#a5d6ff>2</span>);
</span></span><span style=display:flex><span>    expect(users.map(u <span style=color:#ff7b72;font-weight:700>=&gt;</span> u.id)).toEqual([<span style=color:#a5d6ff>&#39;user1&#39;</span>, <span style=color:#a5d6ff>&#39;user2&#39;</span>]);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  it(<span style=color:#a5d6ff>&#39;should return empty array for non-existent IDs&#39;</span>, <span style=color:#ff7b72>async</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>const</span> users <span style=color:#ff7b72;font-weight:700>=</span> <span style=color:#ff7b72>await</span> dataAccess.getUsers([<span style=color:#a5d6ff>&#39;non-existent&#39;</span>]);
</span></span><span style=display:flex><span>    expect(users).toEqual([]); <span style=color:#8b949e;font-style:italic>// エラーではなく空集合
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>  });
</span></span><span style=display:flex><span>});
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic>// サービス層のテスト: ビジネスロジックに集中できる
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>describe(<span style=color:#a5d6ff>&#39;userService.createUser&#39;</span>, () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>  it(<span style=color:#a5d6ff>&#39;should throw error when email already exists&#39;</span>, <span style=color:#ff7b72>async</span> () <span style=color:#ff7b72;font-weight:700>=&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#8b949e;font-style:italic>// データアクセス層をモック
</span></span></span><span style=display:flex><span><span style=color:#8b949e;font-style:italic></span>    jest.spyOn(dataAccess, <span style=color:#a5d6ff>&#39;getUsersByEmail&#39;</span>)
</span></span><span style=display:flex><span>      .mockResolvedValue([{ id<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;existing&#39;</span>, email<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;test@example.com&#39;</span> }]);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#ff7b72>await</span> expect(
</span></span><span style=display:flex><span>      userService.createUser({ email<span style=color:#ff7b72;font-weight:700>:</span> <span style=color:#a5d6ff>&#39;test@example.com&#39;</span> })
</span></span><span style=display:flex><span>    ).rejects.toThrow(BusinessRuleViolationError);
</span></span><span style=display:flex><span>  });
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>このように、各レイヤーの責務が明確になることで、テストも書きやすくなり、コードの品質が向上する。</p><h2 id=おわりに>おわりに
<a class=heading-link href=#%e3%81%8a%e3%82%8f%e3%82%8a%e3%81%ab><i class="fa-solid fa-link" aria-hidden=true title=見出しへのリンク></i>
<span class=sr-only>見出しへのリンク</span></a></h2><p>今回は集合指向的なデータ構造設計とそのアプリケーションサーバーへの適用について考察した。データを集合として捉えることで、データの一貫性を保ちやすくなり、操作も効率的になる。アプリケーションサーバーにおいても、各レイヤーの責務を明確にし、集合指向的なデータ操作を取り入れることで、コードの可読性と保守性が向上するだろう。</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//keep steep.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2024 -
2026
keepSTEEP
·
Powered by <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/ target=_blank rel=noopener>Coder</a>.</section></footer></main><script src=/keepSTEEP/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DNZQ0C6CHB"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-DNZQ0C6CHB")</script></body></html>